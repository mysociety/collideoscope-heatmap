# collideoscope-heatmap

Script to generate the geopackage used for the Collideoscope heatmap (which originated [here](https://github.com/mysociety/collideoscope/issues/25)).

![Heatmap screenshot](https://user-images.githubusercontent.com/4776/45749260-020b0300-bc03-11e8-87b1-284bf30ee50d.png)

The geopackage is generated by combining road features from OS Open Road shapefiles with the points of all incidents in the Collideoscope database. Each feature in the output has a `density` attribute which represents the number of incidents per metre along the feature. Only road features with >1 incident (total) are included.



## Quickstart

The simplest way to generate the geopackage is to use the `Makefile` to get you up and running quickly. Requires Docker and read-only access to the Collideoscope Postgres database.

```bash
$ export COLLIDEOSCOPE_DATABASE_URL="postgres://user:password@postgreshost:5432/collideoscope"
$ curl https://raw.githubusercontent.com/mysociety/collideoscope-heatmap/master/Makefile | make -f - heatmap
```

This takes an hour or so to run, and will generate `heatmap.gpkg` in the current directory.

## Running via Docker

You gain more control over the behaviour of the script by invoking `docker run` manually. For example if you already have OS Open Roads downloaded locally to `$HOME/Downloads` and want to use that, and want the heatmap stored somewhere other than the current directory:

```bash
$ export COLLIDEOSCOPE_DATABASE_URL="postgres://user:password@postgreshost:5432/collideoscope"
$ docker run \
    -e COLLIDEOSCOPE_DATABASE_URL \
    -e OS_OPEN_ROADS_PATH=/input/oproad_essh_gb.zip \
    -e OUTPUT_PATH=/output/collideoscope.gpkg \
    -v /data/library/mapserver:/output \
    -v ${HOME}/Downloads:/input \
    -t davea/collideoscope-heatmap
```

## Running locally

The script uses `pipenv` for virtualenv management, so install that if you haven't already. Then, run the script:

```
$ cat .env
COLLIDEOSCOPE_DATABASE_URL=postgres://user:password@postgreshost:5432/collideoscope
$ pipenv install
$ pipenv run python generate_heatmap.py
```
